<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSMumbai - AI Map Interface</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
        }
        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }

        #ui-panel {
            transition: transform 0.3s ease-in-out;
        }
        .panel-closed {
            transform: translate(calc(100% + 1rem), 0) !important;
        }

        .results-panel::-webkit-scrollbar {
            width: 6px;
        }
        .results-panel::-webkit-scrollbar-thumb {
            background-color: #4b5563; 
            border-radius: 3px;
        }
        .results-panel::-webkit-scrollbar-track {
            background-color: #1f2937; 
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="map-container"></div>

    <div id="ui-panel" class="w-11/12 max-w-lg fixed top-4 z-20 
                 mx-auto left-1/2 -translate-x-1/2 
                 lg:w-96 lg:right-4 lg:left-auto lg:translate-x-0">
        
        <div class="bg-gray-800 bg-opacity-80 backdrop-blur-md rounded-lg shadow-xl p-5">
            <h1 class="text-2xl font-bold mb-4 text-white">OSMumbai AI Map Interface</h1>
            
            <p id="warmup-status" class="text-sm text-yellow-400 mb-4 flex items-center">
                <span class="spinner w-4 h-4 mr-2 border-yellow-300 border-l-yellow-600"></span>
                Warming up the server (Render free-tier cold start)...
            </p>
            <p id="ready-status" class="text-sm text-gray-300 mb-4 hidden">
                Use natural language to query OpenStreetMap data for the Mumbai region. 
                Powered by Agentic AI and PostGIS.
            </p>

            <div class="flex space-x-2">
                <input type="text" id="query-input" placeholder="e.g., 'cafes in bandra'" 
                        class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center w-24 opacity-50 cursor-not-allowed" disabled>
                    Search
                </button>
                <div id="loading-spinner" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center w-24 hidden">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div id="results-panel" class="results-panel bg-gray-800 bg-opacity-80 backdrop-blur-md rounded-lg shadow-xl p-5 mt-4 max-h-[calc(100vh-200px)] overflow-y-auto hidden">
            
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-200">Generated SQL Query</h3>
                    <button id="toggle-sql-button" class="text-sm text-blue-400 hover:text-blue-300 font-medium px-2 py-1 rounded-md transition-colors duration-150">
                        Show Query
                    </button>
                </div>
                
                <div id="sql-content-wrapper" class="hidden">
                    <pre id="sql-query" class="bg-gray-900 text-green-400 p-3 rounded-md text-xs whitespace-pre-wrap"></pre>
                </div>
            </div>
            
            <div class="mt-4">
                <h3 class="text-lg font-semibold text-gray-200 mb-2">Results (<span id="results-count">0</span> found)</h3>
                <div id="table-container" class="overflow-x-auto">
                    <p id="no-results-message" class="text-gray-400">No data returned.</p>
                    <table id="results-table" class="min-w-full divide-y divide-gray-700 hidden">
                        <thead id="table-head" class="bg-gray-700">
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <button id="ui-toggle-button" class="fixed top-4 z-30 p-2 bg-gray-800 bg-opacity-80 backdrop-blur-md rounded-full shadow-xl transition-all duration-300">
        <svg id="toggle-icon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <div id="toast-message" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 hidden">
    </div>


    <script>
        const SERVER_URL = "https://osmumbai.onrender.com";
        let leafletMap = null;
        let geoJsonLayer = null;
        let isPanelOpen = true; 
        const INITIAL_COORDS = [19.0760, 72.8777]; 

        function showAlert(message) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.className = 'fixed bottom-8 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-2xl transition-opacity duration-300';
            toast.classList.add('bg-red-600', 'text-white', 'opacity-100');
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 5000);
        }

        function enableSearchInterface() {
            const queryInput = document.getElementById('query-input');
            const searchButton = document.getElementById('search-button');
            const warmupStatus = document.getElementById('warmup-status');
            const readyStatus = document.getElementById('ready-status');

            queryInput.disabled = false;
            searchButton.disabled = false;
            searchButton.classList.remove('opacity-50', 'cursor-not-allowed');
            warmupStatus.classList.add('hidden');
            readyStatus.classList.remove('hidden');
            queryInput.focus(); 
        }

        async function warmUpServer() {
            try {
                const response = await fetch(SERVER_URL + '/', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(120000) 
                });
                
                if (response.status >= 200) {
                     console.log("Server warmed up successfully.");
                } else {
                    console.warn(`Server woke up but responded with status: ${response.status}. Proceeding.`);
                }
                enableSearchInterface();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error("Warm-up request timed out after 120 seconds. Enabling search interface anyway, but be aware of possible query timeouts.");
                    showAlert("Warning: Server is slow to wake up. Your first query might fail or take up to 2 minutes.");
                } else {
                    console.error("Warm-up request failed due to connection error. Enabling interface.", error);
                    showAlert("Warning: Server connection failed during warm-up. Check server status or try searching.");
                }
                enableSearchInterface();
            }
        }

        function setPanelState(open) {
            const uiPanel = document.getElementById('ui-panel');
            const toggleButton = document.getElementById('ui-toggle-button');
            
            if (!uiPanel || !toggleButton) return;

            if (open) {
                uiPanel.classList.remove('panel-closed');
                
                toggleButton.classList.remove('right-4', 'lg:right-4');
                toggleButton.classList.add('lg:right-[410px]', 'right-4');
                
            } else {
                uiPanel.classList.add('panel-closed');
                
                toggleButton.classList.remove('lg:right-[410px]'); 
                toggleButton.classList.add('lg:right-4', 'right-4'); 
                
            }
            isPanelOpen = open;
        }

        function toggleUIPanel() {
            setPanelState(!isPanelOpen);
        }

        function initMap() {
            if (leafletMap) {
                if (geoJsonLayer) {
                    leafletMap.removeLayer(geoJsonLayer);
                    geoJsonLayer = null;
                }
                leafletMap.setView(INITIAL_COORDS, 11);
                return;
            }
            
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = ''; 

            leafletMap = L.map('map-container').setView(INITIAL_COORDS, 11);
            
            L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(leafletMap);
        }

        function drawGeoJsonFeatures(geoJsonData) {
            if (!leafletMap) {
                initMap();
            }

            if (geoJsonLayer) {
                leafletMap.removeLayer(geoJsonLayer);
                geoJsonLayer = null;
            }

            const features = geoJsonData.features || [];

            if (features.length === 0) {
                showAlert("No geometry features were found for this query.");
                return;
            }
            
            const style = (feature) => {
                const geomType = feature.geometry.type;
                let color = '#3b82f6'; 

                if (geomType === 'Point' || geomType === 'MultiPoint') {
                    color = '#10b981'; 
                } else if (geomType === 'LineString' || geomType === 'MultiLineString') {
                    color = '#f59e0b'; 
                } else {
                    color = '#8b5cf6'; 
                }

                return {
                    fillColor: color,
                    color: color,
                    weight: 3,
                    opacity: 0.8,
                    fillOpacity: 0.5
                };
            };

            geoJsonLayer = L.geoJSON(geoJsonData, {
                style: style,
                pointToLayer: (feature, latlng) => {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: '#10b981',
                        color: '#059669',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.9
                    });
                },
                onEachFeature: (feature, layer) => {
                    let popupContent = "<strong>Feature Details</strong><br>";
                    if (feature.properties) {
                        for (const key in feature.properties) {
                            if (key.toLowerCase() !== 'geojson' && feature.properties[key]) {
                                popupContent += `<strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${feature.properties[key]}<br>`;
                            }
                        }
                    }
                    layer.bindPopup(popupContent);
                }
            }).addTo(leafletMap);

            try {
                if (geoJsonLayer.getBounds && geoJsonLayer.getBounds().isValid()) {
                    leafletMap.fitBounds(geoJsonLayer.getBounds(), { padding: [20, 20] });
                } else {
                    console.warn("GeoJSON layer bounds are invalid or empty. Keeping default zoom.");
                }
            } catch (e) {
                 console.error("Error setting map bounds:", e);
            }
        }
        
        function zoomToFeature(feature) {
            if (!leafletMap || !feature || !feature.geometry) {
                console.warn("Cannot zoom: Map or feature geometry is missing.");
                showAlert("Cannot zoom to feature: Missing geometry.");
                return;
            }

            try {
                const tempLayer = L.geoJSON(feature);
                
                if (tempLayer.getBounds && tempLayer.getBounds().isValid()) {
                    leafletMap.fitBounds(tempLayer.getBounds(), { padding: [50, 50] }); 
                } else if (feature.geometry.type.includes('Point')) {
                    const coords = feature.geometry.coordinates;
                    const latlng = [coords[1], coords[0]]; 
                    leafletMap.setView(latlng, 15); 
                } else {
                    showAlert("Could not calculate zoom area for feature.");
                    return;
                }
                
            } catch (e) {
                console.error("Error setting map view for feature:", e);
                showAlert("An error occurred while zooming to the feature.");
            }
        }

        function renderTabularResults(data, featuresArray) {
            const resultsCountEl = document.getElementById('results-count');
            const resultsTable = document.getElementById('results-table');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            const noResultsMessage = document.getElementById('no-results-message');

            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            const rowsCount = data.rows_count || 0;
            resultsCountEl.textContent = rowsCount;

            if (rowsCount > 0 && data.headers && data.display_rows) {
                const headerRow = document.createElement('tr');
                data.headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = "px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider";
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);

                data.display_rows.forEach((row, index) => { 
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-700 cursor-pointer";
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.className = "px-4 py-2 whitespace-nowrap text-sm text-gray-200";
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    
                    tr.addEventListener('click', () => {
                        console.log('Row clicked:', row);
                        if (featuresArray.length > index) {
                            zoomToFeature(featuresArray[index]);
                        } else {
                            console.warn("Feature index out of bounds:", index);
                            showAlert("Cannot find map feature for this row.");
                        }
                    });
                    
                    tableBody.appendChild(tr);
                });
                
                resultsTable.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
            } else {
                resultsTable.classList.add('hidden');
                noResultsMessage.classList.remove('hidden');
            }
        }

        async function handleSearch() {
            const queryInput = document.getElementById('query-input');
            const query = queryInput.value.trim();
            if (!query) {
                showAlert("Please enter a query.");
                return;
            }

            const searchButton = document.getElementById('search-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultsPanel = document.getElementById('results-panel');
            const sqlQueryEl = document.getElementById('sql-query');
            const sqlContentWrapper = document.getElementById('sql-content-wrapper');
            const toggleSqlButton = document.getElementById('toggle-sql-button');
            
            if (sqlContentWrapper && !sqlContentWrapper.classList.contains('hidden')) {
                sqlContentWrapper.classList.add('hidden');
            }
            if (toggleSqlButton) {
                toggleSqlButton.textContent = 'Show Query';
                isSqlVisible = false; 
            }


            searchButton.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            resultsPanel.classList.add('hidden');

            sqlQueryEl.textContent = 'Generating SQL...';

            try {
                const payload = { query: query, max_rows: 500 };
                
                const response = await fetch(`${SERVER_URL}/nl-to-map`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(120000) 
                });

                if (!response.ok) {
                    const contentType = response.headers.get("content-type");
                    let errorDetail = `HTTP error! Status: ${response.status}`;
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errorData = await response.json();
                        errorDetail = errorData.detail || errorDetail;
                    }

                    throw new Error(errorDetail);
                }

                const data = await response.json();

                resultsPanel.classList.remove('hidden');
                
                sqlQueryEl.textContent = data.sql || "No SQL query returned.";
                
                const geoJsonData = data.geo_json_features || data.map_html; 

                if (geoJsonData && geoJsonData.type === 'FeatureCollection') {
                    drawGeoJsonFeatures(geoJsonData);
                } else {
                    showAlert("No map features found for this result. Showing initial map view.");
                    if (!leafletMap) initMap(); 
                }
                
                const featuresArray = geoJsonData && geoJsonData.features ? geoJsonData.features : [];
                renderTabularResults(data, featuresArray); 

            } catch (error) {
                console.error('Fetch error:', error);
                showAlert(`Error fetching data: ${error.message}. This is likely a timeout issue.`);
                if (!leafletMap) {
                    initMap();
                }
            } finally {
                searchButton.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
        let isSqlVisible = false;

        function toggleSqlDisplay() {
            const sqlContentWrapper = document.getElementById('sql-content-wrapper');
            const toggleSqlButton = document.getElementById('toggle-sql-button');
            
            if (isSqlVisible) {
                sqlContentWrapper.classList.add('hidden');
                toggleSqlButton.textContent = 'Show Query';
            } else {
                sqlContentWrapper.classList.remove('hidden');
                toggleSqlButton.textContent = 'Hide Query';
            }
            isSqlVisible = !isSqlVisible;
        }


        document.addEventListener('DOMContentLoaded', () => {
             initMap(); 
             setPanelState(true); 
             warmUpServer(); 
        });

        document.getElementById('search-button').addEventListener('click', handleSearch);
        document.getElementById('query-input').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        document.getElementById('ui-toggle-button').addEventListener('click', toggleUIPanel);
        
        const toggleSqlButton = document.getElementById('toggle-sql-button');
        if (toggleSqlButton) {
            toggleSqlButton.addEventListener('click', toggleSqlDisplay);
        }

    </script>
</body>
</html>
